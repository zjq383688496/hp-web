!function(a){if(a&&window.ArtJS&&(ArtJS.namespace("ArtJS.ui"),!ArtJS.ui.calendar)){var b="ui-calendar",c=ArtJS.lang.get(b)||{year:"年",month:"月",weekday:"日,一,二,三,四,五,六",lastmonth:"上{months}月",nextmonth:"下{months}月",lastyear:"上一年",nextyear:"下一年",today:"今天",clear:"清空"};ArtJS.ui.calendar=function(b,c){b.each(function(){var b=a(this),e=c||b.attrJSON();new d(b,e)})};var d=function(d,e){var f=this;this.data={id:b,today:new Date,elementStyle:"jui-calendar-source"},this.tmpl={container:['<div id="'+b+'" style="display:none;">','<div class="date-months"></div>','<div class="date-footer">','<span class="date-time">','<input type="text" class="date-sel-h" value="00" data-min="0" data-max="23" maxlength="2" />:','<input type="text" class="date-sel-m" value="00" data-min="0" data-max="59" maxlength="2" />:','<input type="text" class="date-sel-s" value="00" data-min="0" data-max="59" maxlength="2" />',"</span>",'<a class="date-button date-today">'+c.today+"</a>",'<a class="date-clear">'+c.clear+"</a>","</div>",'<div class="date-switch">','<a class="date-button nextmonth">&#187;</a>','<a class="date-button lastmonth">&#171;</a>','<ul class="date-yearlist"></ul>','<ul class="date-monthlist"></ul>',"</div>","</div>"].join("")},this.init=function(b,c){b.hasClass(this.data.elementStyle)||(b.addClass(this.data.elementStyle),c.bdate&&b.attr("bdate",c.bdate),c.edate&&b.attr("edate",c.edate),b.focus(function(){f.showCalendar()}),"label"==b.parent().tagName()&&b.click(function(){return!1})),this.data.element=b,this.data.format=c.format||"yyyy-mm-dd",this.data.months=c.months||2,this.data.footer=c.footer||!1,c.disablePrev&&(this.data.disablePrev="string"==typeof c.disablePrev?c.disablePrev.parseDate():c.disablePrev),this.data.format.indexOf(":")>0&&(this.data.timeEnabled=!0,this.data.footer=!0),this.data.callback=c.callback,this.container=a("#"+this.data.id),0===this.container.length&&(this.container=a(this.tmpl.container),a("body").append(this.container),this.footer.initTimes(),this.container.bind("mouseover",function(){f.data.showStatus=!0}),a(document).bind("mousedown",function(b){var c=b||window.event||null,d=c?c.srcElement||c.target:null,e=!0;"object"==typeof d&&(a(d).hasClass(f.data.elementStyle)||a(d).parents("#"+f.data.id).length>0)&&(e=!1),e&&f.hideCalendar()}))},this.showCalendar=function(){this.data.showStatus=!0,this.data.bdate=this.data.element.attr("bdate")?this.data.element.attr("bdate").parseDate():null,this.data.edate=this.data.element.attr("edate")?this.data.element.attr("edate").parseDate():null,this.data.cdate=""===this.data.element.val()?null:this.data.element.val().parseDate(),this.months.init(),this.buttons.init(),this.selyear.init(),this.selmonth.init(),this.footer.init(),this.data.showStatus=!0,this.container.show(),this.resize()},this.hideCalendar=function(){this.data.showStatus=!1,setTimeout(function(){f.data.showStatus||f.container.fadeOut()},200)},this.months={tmpl:{month:['<div class="date-month">','<div class="date-title"><span year="{year}">{year} '+c.year+'</span><span month="{month}">{month} '+c.month+"</span></div>",'<div class="date-weeks"></div>','<div class="date-items"></div>',"</div>"].join(""),weeklabel:'<label class="week{1}">{0}</label>',foretime:"<span>{0}</span>",datetime:'<a href="javascript:void(0);" class="{2}" date="{1}">{0}</a>'},init:function(b,d){b||(b=(f.data.cdate||f.data.bdate||f.data.edate||new Date).getFullYear(),d=(f.data.cdate||f.data.bdate||f.data.edate||new Date).getMonth()),f.data.year=new Date(b,d,1).getFullYear(),f.data.month=new Date(b,d,1).getMonth();var e,g,h,i,j,k,l,m,n,o,p,q=c.weekday.split(","),r=f.container.find(".date-months");for(r.html(""),m=0;m<f.data.months;m++){for(e=new Date(b,d+m,1),j=e.getFullYear(),i=e.getMonth(),h=e.getDate(),g=e.getDay(),n=a(this.tmpl.month.substitute({year:j,month:i+1})),o=n.find(".date-weeks"),p=n.find(".date-items"),r.append(n),l=0;l<=q.length-1;l++)o.append(this.tmpl.weeklabel.format(q[l],l));for(l=1;g>=l;l++)p.append(this.tmpl.foretime.format(""));for(;e.getMonth()==i;)k=e.format("yyyy-mm-dd"),p.append(f.data.disablePrev&&k<f.data.disablePrev.format("yyyy-mm-dd")?this.tmpl.foretime.format(h):f.data.bdate&&k<f.data.bdate.format("yyyy-mm-dd")?this.tmpl.foretime.format(h):f.data.edate&&k>f.data.edate.format("yyyy-mm-dd")?this.tmpl.foretime.format(h):f.data.cdate&&f.data.cdate.format("yyyy-mm-dd")==k?this.tmpl.datetime.format(h,k,"current"):f.data.today&&f.data.today.format("yyyy-mm-dd")==k?this.tmpl.datetime.format(h,k,"today"):this.tmpl.datetime.format(h,k,"")),e.setDate(++h);for(;42>=h+g;)p.append(this.tmpl.foretime.format("")),h++;p.find("a").click(function(){var b=a(this).attr("date");return f.setVal(b),!1})}r.find(".date-title span[year]").click(function(){f.selyear.toggle(),f.selmonth.hide()}),r.find(".date-title span[month]").click(function(){f.selmonth.toggle(),f.selyear.hide()})},setVal:function(){f.container.find(".date-months a.current").click()}},this.footer={init:function(){return this.element=f.container.find(".date-footer"),f.data.footer?(this.element.show(),this.initToday(),this.initClear(),void this.updateTimes()):(this.element.hide(),!1)},initToday:function(){var b=(new Date).format("yyyy-mm-dd");f.data.bdate&&f.data.bdate.format("yyyy-mm-dd")>b?this.element.find(".date-today").addClass("disabled"):f.data.edate&&f.data.edate.format("yyyy-mm-dd")<b?this.element.find(".date-today").addClass("disabled"):this.element.find(".date-today").removeClass("disabled"),this.element.find(".date-today").unbind("click").bind("click",function(){return a(this).hasClass("disabled")||f.setVal(b),!1})},initClear:function(){this.element.find(".date-clear").unbind("click").bind("click",function(){return f.setVal(""),!1})},initTimes:function(){this.element=f.container.find(".date-footer");var b=this.element.find(".date-time input");b.css("ime-mode","disabled"),b.bind("paste",function(){return!clipboardData.getData("text").match(/\D/)}),b.bind("dragenter",function(){return!1}),b.bind("blur",function(){var b=parseInt(a(this).attr("data-max"),10);if(""==this.value||isNaN(this.value))this.value="00";else{var c=parseInt(this.value,10);this.value=c>b?b:c.padLeft(2,"0")}})},updateTimes:function(){{var b=f.data.cdate||new Date,c=b.getHours(),d=b.getMinutes(),e=b.getSeconds();(new Date).format("yyyy-mm-dd")}f.data.timeEnabled?(this.element.find(".date-time").show(),this.element.find(".date-sel-h").val(c.padLeft(2,"0")),this.element.find(".date-sel-m").val(d.padLeft(2,"0")),this.element.find(".date-sel-s").val(e.padLeft(2,"0")),this.element.find(".date-time input").unbind("keypress").bind("keypress",function(b){try{if(b.shiftKey)return!1;var c=b.which||b.keyCode||0;if(13!=c)return 8==c||0===b.which&&37==b.keyCode||0===b.which&&39==b.keyCode||c>=48&&57>=c||0===b.which&&46==b.keyCode;a(this).blur(),f.months.setVal()}catch(d){}})):this.element.find(".date-time").hide()},getTimeVal:function(){var a=this.element.find(".date-sel-h").val(),b=this.element.find(".date-sel-m").val(),c=this.element.find(".date-sel-s").val();return a+":"+b+":"+c}},this.buttons={init:function(){this.lastmonth=f.container.find(".lastmonth"),this.lastmonth.attr("title",c.lastmonth.substitute({months:f.data.months})),this.lastmonth.unbind("click").bind("click",function(){f.months.init(f.data.year,f.data.month-f.data.months),f.buttons.update()}),this.nextmonth=f.container.find(".nextmonth"),this.nextmonth.attr("title",c.nextmonth.substitute({months:f.data.months})),this.nextmonth.unbind("click").bind("click",function(){f.months.init(f.data.year,f.data.month+f.data.months),f.buttons.update()}),this.update()},update:function(){f.data.disablePrev&&f.data.disablePrev>=new Date(f.data.year,f.data.month,1,0,0,0)?this.lastmonth.hide():this.lastmonth.show()}},this.selyear={tmpl:{yearprev:'<li class="yearswitch" year="{0}">&#171;</li>',yearnext:'<li class="yearswitch" year="{0}">&#187;</li>',yearitem:'<li year="{0}">{0}'+c.year+"</li>"},init:function(){this.element=f.container.find(".date-yearlist"),this.update(f.data.year-4),this.hide()},update:function(b){var c=this;this.element.html(this.tmpl.yearprev.format(b-10));for(var d=b;b+10>d;d++)this.element.append(this.tmpl.yearitem.format(d));if(this.element.append(this.tmpl.yearnext.format(b+10)),f.data.disablePrev){var b=f.data.disablePrev.getFullYear();this.element.find("li:gt(0)").each(function(){a(this).attr("year")<b&&a(this).addClass("disabled")}),this.element.find("li.disabled").length>0&&this.element.find("li:first").addClass("disabled")}this.element.find("li").bind("click",function(){var b=parseInt(a(this).attr("year"),10);a(this).hasClass("disabled")||(a(this).hasClass("yearswitch")?c.update(b):(f.months.init(b,f.data.month),f.selmonth.update(),f.buttons.update(),c.hide()))})},toggle:function(){this.element.toggle()},show:function(){this.element.show()},hide:function(){this.element.hide()}},this.selmonth={tmpl:{monthitem:'<li month="{0}">{0}'+c.month+"</li>"},init:function(){this.element=f.container.find(".date-monthlist"),this.update(),this.hide()},update:function(){var b=this;this.element.html("");for(var c=1;12>=c;c++)this.element.append(this.tmpl.monthitem.format(c));if(f.data.disablePrev&&f.data.disablePrev.getFullYear()==f.data.year){var d=f.data.disablePrev.getMonth()+1;this.element.find("li").each(function(){a(this).attr("month")<d&&a(this).addClass("disabled")})}this.element.find("li").bind("click",function(){var c=parseInt(a(this).attr("month"),10);a(this).hasClass("disabled")||(f.months.init(f.data.year,c-1),f.buttons.update(),b.hide())})},toggle:function(){this.element.toggle()},show:function(){this.element.show()},hide:function(){this.element.hide()}},this.resize=function(){var b=a("body").width(),c=this.data.element.offset(),d=this.data.element.outerWidth(),e=this.data.element.outerHeight();this.container.css({width:this.container.find(".date-month:first").outerWidth()*this.data.months}),this.container.css(b-c.left>=this.container.width()?{top:c.top+e,left:c.left,right:"auto"}:{top:c.top+e,right:b-c.left-d,left:"auto"})},this.setVal=function(a){this.data.timeEnabled&&""!=a&&(a+=" "+this.footer.getTimeVal()),this.data.element.val(a.parseDate().format(this.data.format)),this.data.showStatus=!1,this.container.hide(),this.data.callback&&this.data.callback(a)},this.init(d,e)};ArtJS.debug("calendar.js","初始化成功")}}(jQuery);